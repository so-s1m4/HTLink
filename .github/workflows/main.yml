name: CI/CD Pipeline

on:
  push:
    branches: [ dev ]
  pull_request:
    types: [ closed ]
    branches: [ dev ]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          base: ${{ github.ref }}
          filters: |
            backend:
              - 'server/**'
            frontend:
              - 'client/**'

      - name: Print detected changes
        run: |
          echo "Backend changed: ${{ steps.filter.outputs.backend }}"
          echo "Frontend changed: ${{ steps.filter.outputs.frontend }}"

  notifyStart:
    runs-on: ubuntu-latest
    if: always()
    env:
      COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      BRANCH_NAME: ${{ github.ref_name }}
      COMMITED_BY: ${{ github.event.head_commit.author.username || github.actor }}
    steps:
      - name: Send Telegram start notification
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          TEXT="üöÄ –°—Ç–∞—Ä—Ç CI/CD

          üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $GITHUB_REPOSITORY
          üåø –í–µ—Ç–∫–∞: $BRANCH_NAME
          üî¢ –ö–æ–º–º–∏—Ç: $SHORT_SHA
          üë§ –ê–≤—Ç–æ—Ä: $COMMITED_BY

          üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ:
          $COMMIT_MESSAGE

          üîó –ó–∞–ø—É—Å–∫: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TG_CHAT_ID }}" \
            --data-urlencode "text=$TEXT"

  build-and-test:
    runs-on: ubuntu-latest
    needs: changes
    # —Ç–µ—Å—Ç–∏–º backend —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ server/**
    if: needs.changes.outputs.backend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          cd server
          npm i

      - name: Run tests
        run: |
          cd server
          npx jest

      - name: Build project
        run: |
          cd server
          npx tsc

  docker-backend:
    runs-on: ubuntu-latest
    needs: [changes, build-and-test]
    if: needs.changes.outputs.backend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./server
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/htlink-backend:latest
          platforms: linux/amd64,linux/arm64

  docker-frontend:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push frontend Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./client
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/htlink-frontend:latest
          platforms: linux/amd64,linux/arm64
  notifyEnd:
    runs-on: ubuntu-latest
    needs: [changes, docker-backend, docker-frontend]
    if: always()
    env:
      COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      BRANCH_NAME: ${{ github.ref_name }}
      COMMITED_BY: ${{ github.event.head_commit.author.username || github.actor }}
    steps:
      - name: Send Telegram result
        run: |
          BACKEND_STATUS="${{ needs['docker-backend'].result }}"
          FRONTEND_STATUS="${{ needs['docker-frontend'].result }}"
          TAILSCALE_STATUS="${{ needs['docker-tailscale'].result }}"
  
          # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞ —Å—Ç–∞—Ç—É—Å–∞
          pretty_status () {
            case "$1" in
              success) echo "‚úÖ success" ;;
              skipped) echo "‚è≠ skipped" ;;
              failure) echo "‚ùå failure" ;;
              cancelled) echo "‚ö†Ô∏è cancelled" ;;
              *) echo "‚ùì unknown" ;;
            esac
          }
  
          BACKEND_PRETTY=$(pretty_status "$BACKEND_STATUS")
          FRONTEND_PRETTY=$(pretty_status "$FRONTEND_STATUS")
  
          # –û–±—â–∏–π –∏—Ç–æ–≥
          if [ "$BACKEND_STATUS" = "failure" ] || \
             [ "$FRONTEND_STATUS" = "failure" ]; then
            STATUS_ICON="‚ùå"
            STATUS_TEXT="–û—à–∏–±–∫–∞ –≤ –æ–¥–Ω–æ–º –∏–∑ Docker-–±–∏–ª–¥–æ–≤"
          else
            STATUS_ICON="‚úÖ"
            STATUS_TEXT="CI/CD –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
          fi
  
          SHORT_SHA=${GITHUB_SHA::7}
  
          TEXT="$STATUS_ICON –†–µ–∑—É–ª—å—Ç–∞—Ç CI/CD
  
          $STATUS_TEXT
          
          üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $GITHUB_REPOSITORY
          üåø –í–µ—Ç–∫–∞: $BRANCH_NAME
          üî¢ –ö–æ–º–º–∏—Ç: $SHORT_SHA
          üë§ –ê–≤—Ç–æ—Ä: $COMMITED_BY
          
          üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ:
          $COMMIT_MESSAGE
          
          ‚öôÔ∏è –°—Ç–∞—Ç—É—Å—ã Docker:
          - backend: $BACKEND_PRETTY
          - frontend: $FRONTEND_PRETTY
          
          üîó Run:
          $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
  
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TG_CHAT_ID }}" \
            --data-urlencode "text=$TEXT"
