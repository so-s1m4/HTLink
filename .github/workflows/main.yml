name: CI/CD Pipeline

on:
  push:
    branches: [ dev ]
  pull_request:
    types: [ closed ]
    branches: [ dev ]

jobs:
  changes:
      runs-on: ubuntu-latest
      outputs:
        backend: ${{ steps.filter.outputs.backend }}
        frontend: ${{ steps.filter.outputs.frontend }}
      steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Detect changed paths
          id: filter
          uses: dorny/paths-filter@v3
          with:
            filters: |
              backend:
                - 'server/**'
              frontend:
                - 'client/**'

  notifyStart:
      runs-on: ubuntu-latest
      if: always()
      env:
        COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        BRANCH_NAME: ${{ github.ref_name }}
        COMMITED_BY: ${{ github.event.head_commit.author.username }}
      steps:
        - name: Send Telegram result
          run: |
            SHORT_SHA=${GITHUB_SHA::7}
            TEXT="üöÄ –°—Ç–∞—Ä—Ç CI/CD

            üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $GITHUB_REPOSITORY
            üåø –í–µ—Ç–∫–∞: $BRANCH_NAME
            üî¢ –ö–æ–º–º–∏—Ç: $SHORT_SHA
            üë§ –ê–≤—Ç–æ—Ä: $COMMITED_BY
            
            üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ:
            $COMMIT_MESSAGE
            
            üîó –ó–∞–ø—É—Å–∫: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"

            curl -s -X POST https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage \
              -d chat_id=${{ secrets.TG_CHAT_ID }} \
              --data-urlencode text="$TEXT"
              
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          cd server
          npm i

      - name: Run tests
        run: |
          cd server
          npx jest

      - name: Build project
        run: |
          cd server
          npx tsc

  docker-backend:
    runs-on: ubuntu-latest
    needs: [changes, build-and-test]
    if: needs.changes.outputs.backend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push backend Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./server
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/htlink-backend:latest
          platforms: linux/amd64,linux/arm64

  docker-frontend:
    runs-on: ubuntu-latest
    needs: [changes, build-and-test]
    if: needs.changes.outputs.frontend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push frontend Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./client
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/htlink-frontend:latest
          platforms: linux/amd64,linux/arm64

  notifyEnd:
    runs-on: ubuntu-latest
    needs: [changes, docker-backend, docker-frontend]
    if: always()
    env:
      COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      BRANCH_NAME: ${{ github.ref_name }}
      COMMITED_BY: ${{ github.event.head_commit.author.username || github.actor }}
    steps:
      - name: Send Telegram result
        run: |
          BACKEND_STATUS="${{ needs.docker.result }}"
          FRONTEND_STATUS="${{ needs['docker-frontend'].result }}"

          if [ "$BACKEND_STATUS" = "success" ] && [ "$FRONTEND_STATUS" = "success" ]; then
            STATUS_ICON="‚úÖ"
            STATUS_TEXT="Docker-–±–∏–ª–¥—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ (backend + frontend)"
          elif [ "$BACKEND_STATUS" = "success" ] && [ "$FRONTEND_STATUS" = "skipped" ]; then
            STATUS_ICON="‚úÖ"
            STATUS_TEXT="–°–æ–±—Ä–∞–Ω —Ç–æ–ª—å–∫–æ backend (–∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–æ frontend –Ω–µ –±—ã–ª–æ)"
          elif [ "$BACKEND_STATUS" = "skipped" ] && [ "$FRONTEND_STATUS" = "success" ]; then
            STATUS_ICON="‚úÖ"
            STATUS_TEXT="–°–æ–±—Ä–∞–Ω —Ç–æ–ª—å–∫–æ frontend (–∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ backend –Ω–µ –±—ã–ª–æ)"
          else
            STATUS_ICON="‚ùå"
            STATUS_TEXT="–û—à–∏–±–∫–∞ –≤ –æ–¥–Ω–æ–º –∏–∑ Docker-–±–∏–ª–¥–æ–≤"
          fi

          SHORT_SHA=${GITHUB_SHA::7}

          TEXT="$STATUS_ICON –†–µ–∑—É–ª—å—Ç–∞—Ç CI/CD

          $STATUS_TEXT
          
          üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $GITHUB_REPOSITORY
          üåø –í–µ—Ç–∫–∞: $BRANCH_NAME
          üî¢ –ö–æ–º–º–∏—Ç: $SHORT_SHA
          üë§ –ê–≤—Ç–æ—Ä: $COMMITED_BY
          
          üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ:
          $COMMIT_MESSAGE
          
          ‚öôÔ∏è –°—Ç–∞—Ç—É—Å—ã Docker:
          - backend: $BACKEND_STATUS
          - frontend: $FRONTEND_STATUS
          
          üîó Run: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TG_CHAT_ID }}" \
            --data-urlencode "text=$TEXT"

  # deploy:
  #   runs-on: ubuntu-latest
  #   needs: docker
  #   steps:
  #     - name: Deploy to VPS via SSH
  #       uses: appleboy/ssh-action@v1.0.3
  #       with:
  #         host: ${{ secrets.SSH_HOST }}
  #         username: ${{ secrets.SSH_USER }}
  #         key: ${{ secrets.SSH_KEY }}
  #         script: |
  #           cd /root/HTLink
  #           git fetch origin
  #           git checkout dev
  #           git pull origin dev
  #           docker compose pull
  #           docker compose up -d
  #           docker image prune -f
